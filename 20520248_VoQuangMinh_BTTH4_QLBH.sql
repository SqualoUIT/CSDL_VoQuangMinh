create database QLBH
drop database QLBH
use QLBH

/*Tạo bảng khách hàng*/
create table KHACHHANG
(
    MAKH char(4) constraint PK primary key,
	HOTEN varchar(40),
	DIACHI varchar(40),
	SODT varchar(20),
	NGAYSINH smalldatetime,
	DOANHSO money,
	NGAYDK smalldatetime
)

/*Tạo bảng nhân viên*/
create table NHANVIEN 
(
    MANV char(4) constraint PK_NV primary key,
	HOTEN varchar(40),
	SODT varchar(20),
	NGAYVAOLAM smalldatetime
)

/*Tạo bảng sản phẩm*/
create table SANPHAM
(
    MASP char(4) constraint PK_SP primary key,
	TENSP varchar(40),
	DVT varchar(20),
	NUOCSX varchar(40),
	GIA money
)

/*Tạo bảng hóa đơn*/
create table HOADON
(
    SOHD int constraint PK_HD primary key,
	NGHD smalldatetime,
	MAKH char(4) constraint FK_HD_KH foreign key references KHACHHANG(MAKH),
	MANV char(4) constraint FK_HD_NV foreign key references NHANVIEN(MANV),
	TRIGIA money
)

/*Tạo bảng chi tiết hóa đơn*/
create table CTHD
(
    SOHD int,
	MASP char(4),
	SL int
	constraint PK_CTHD primary key(SOHD,MASP)
)

/*Set kiểu ngày tháng năm*/
set dateformat dmy

/*Insert dữ liệu nhân viên*/
insert into NHANVIEN values ('NV01','Nguyen Nhu Nhut','0927345678','13/4/2006')
insert into NHANVIEN values ('NV02','Le Thi Phi Yen','0987567390','21/4/2006')
insert into NHANVIEN values ('NV03','Nguyen Van B','0997047382','27/4/2006')
insert into NHANVIEN values ('NV04','Ngo Thanh Tuan','0913758498','24/6/2006')
insert into NHANVIEN values ('NV05','Nguyen Thi Truc Thanh','0918590387','20/7/2006')

/*Insert dữ liệu khách hàng*/
INSERT INTO KHACHHANG VALUES ('KH01','Nguyen Van A','731 Tran Hung Dao, Q5, TpHCM','08823451','22/10/1960 ',13060000 ,'22/07/2006')
INSERT INTO KHACHHANG VALUES ('KH02','Tran Ngoc Han','23/5 Nguyen Trai, Q5, TpHCM','0908256478','3/4/1974 ',280000 ,'30/07/2006')
INSERT INTO KHACHHANG VALUES ('KH03','Tran Ngoc Linh','45 Nguyen Canh Chan, Q1, TpHCM','0938776266','12/6/1980 ',3860000 ,'05/08/2006')
INSERT INTO KHACHHANG VALUES ('KH04','Tran Minh Long','50/34 Le Dai Hanh, Q10, TpHCM','0917325476','9/3/1965 ',250000 ,'02/10/2006')
INSERT INTO KHACHHANG VALUES ('KH05','Le Nhat Minh','34 Truong Dinh, Q3, TpHCM','08246108','10/3/1950 ',21000 ,'28/10/2006')
INSERT INTO KHACHHANG VALUES ('KH06','Le Hoai Thuong','227 Nguyen Van Cu, Q5, TpHCM','08631738','31/12/1981 ',915000 ,'24/11/2006')
INSERT INTO KHACHHANG VALUES ('KH07','Nguyen Van Tam','32/3 Tran Binh Trong, Q5, TpHCM','0916783565','6/4/1971 ',12500 ,'01/12/2006')
INSERT INTO KHACHHANG VALUES ('KH08','Phan Thi Thanh','45/2 An Duong Vuong, Q5, TpHCM','0938435756','10/1/1971 ',365000 ,'13/12/2006')
INSERT INTO KHACHHANG VALUES ('KH09','Le Ha Vinh','873 Le Hong Phong, Q5, TpHCM','08654763','3/9/1979 ',70000 ,'14/01/2007')
INSERT INTO KHACHHANG VALUES ('KH10','Ha Duy Lap','34/34B Nguyen Trai, Q1, TpHCM','08768904','2/5/1983 ',67500 ,'16/01/2007')

/*Insert dữ liệu sãn phẩm*/
INSERT INTO SANPHAM VALUES('BC01','But chi','cay','Singapore',3000)
INSERT INTO SANPHAM VALUES('BC02','But chi','cay','Singapore',5000)
INSERT INTO SANPHAM VALUES('BC03','But chi','cay','Viet Nam',3500)
INSERT INTO SANPHAM VALUES('BC04','But chi','hop','Viet Nam',30000)
INSERT INTO SANPHAM VALUES('BB01','But bi','cay','Viet Nam',5000)
INSERT INTO SANPHAM VALUES('BB02','But bi','cay','Trung Quoc',7000)
INSERT INTO SANPHAM VALUES('BB03','But bi','hop','Thai Lan',100000)
INSERT INTO SANPHAM VALUES('TV01','Tap 100 giay mong','quyen','Trung Quoc',2500)
INSERT INTO SANPHAM VALUES('TV02','Tap 200 giay mong','quyen','Trung Quoc',4500)
INSERT INTO SANPHAM VALUES('TV03','Tap 100 giay tot','quyen','Viet Nam',3000)
INSERT INTO SANPHAM VALUES('TV04','Tap 200 giay tot','quyen','Viet Nam',5500)
INSERT INTO SANPHAM VALUES('TV05','Tap 100 trang','chuc','Viet Nam',23000)
INSERT INTO SANPHAM VALUES('TV06','Tap 200 trang','chuc','Viet Nam',53000)
INSERT INTO SANPHAM VALUES('TV07','Tap 100 trang','chuc','Trung Quoc',34000)
INSERT INTO SANPHAM VALUES('ST01','So tay 500 trang','quyen','Trung Quoc',40000)
INSERT INTO SANPHAM VALUES('ST02','So tay loai 1','quyen','Viet Nam',55000)
INSERT INTO SANPHAM VALUES('ST03','So tay loai 2','quyen','Viet Nam',51000)
INSERT INTO SANPHAM VALUES('ST04','So tay','quyen','Thai Lan',55000)
INSERT INTO SANPHAM VALUES('ST05','So tay mong','quyen','Thai Lan',20000)
INSERT INTO SANPHAM VALUES('ST06','Phan viet bang','hop','Viet Nam',5000)
INSERT INTO SANPHAM VALUES('ST07','Phan khong bui','hop','Viet Nam',7000)
INSERT INTO SANPHAM VALUES('ST08','Bong bang','cai','Viet Nam',1000)
INSERT INTO SANPHAM VALUES('ST09','But long','cay','Viet Nam',5000)
INSERT INTO SANPHAM VALUES('ST10','But long','cay','Trung Quoc',7000)

/*Insert dữ liệu hóa đơn*/
INSERT INTO HOADON VALUES('1001','23/07/2006','KH01','NV01',320000)
INSERT INTO HOADON VALUES('1002','12/08/2006','KH01','NV02',840000)
INSERT INTO HOADON VALUES('1003','23/08/2006','KH02','NV01',100000)
INSERT INTO HOADON VALUES('1004','01/09/2006','KH02','NV01',180000)
INSERT INTO HOADON VALUES('1005','20/10/2006','KH01','NV02',3800000)
INSERT INTO HOADON VALUES('1006','16/10/2006','KH01','NV03',2430000)
INSERT INTO HOADON VALUES('1007','28/10/2006','KH03','NV03',510000)
INSERT INTO HOADON VALUES('1008','28/10/2006','KH01','NV03',440000)
INSERT INTO HOADON VALUES('1009','28/10/2006','KH03','NV04',200000)
INSERT INTO HOADON VALUES('1010','01/11/2006','KH01','NV01',5200000)
INSERT INTO HOADON VALUES('1011','04/11/2006','KH04','NV03',250000)
INSERT INTO HOADON VALUES('1012','30/11/2006','KH05','NV03',21000)
INSERT INTO HOADON VALUES('1013','12/12/2006','KH06','NV01',5000)
INSERT INTO HOADON VALUES('1014','31/12/2006','KH03','NV02',3150000)
INSERT INTO HOADON VALUES('1015','01/01/2007','KH06','NV01',910000)
INSERT INTO HOADON VALUES('1016','01/01/2007','KH07','NV02',12500)
INSERT INTO HOADON VALUES('1017','02/01/2007','KH08','NV03',35000)
INSERT INTO HOADON VALUES('1018','13/01/2007','KH08','NV03',330000)
INSERT INTO HOADON VALUES('1019','13/01/2007','KH01','NV03',30000)
INSERT INTO HOADON VALUES('1020','14/01/2007','KH09','NV04',70000)
INSERT INTO HOADON VALUES('1021','16/01/2007','KH10','NV03',67500)
INSERT INTO HOADON VALUES('1022','16/01/2007',Null,'NV03',7000)
INSERT INTO HOADON VALUES('1023','17/01/2007',Null,'NV01',330000)

/*Insert dữ liệu Chi tiết hoa đơn*/
INSERT INTO CTHD VALUES(1001,'TV02',10)
INSERT INTO CTHD VALUES(1001,'ST01',5)
INSERT INTO CTHD VALUES(1001,'BC01',5)
INSERT INTO CTHD VALUES(1001,'BC02',10)
INSERT INTO CTHD VALUES(1001,'ST08',10)
INSERT INTO CTHD VALUES(1002,'BC04',20)
INSERT INTO CTHD VALUES(1002,'BB01',20)
INSERT INTO CTHD VALUES(1002,'BB02',20)
INSERT INTO CTHD VALUES(1003,'BB03',10)
INSERT INTO CTHD VALUES(1004,'TV01',20)
INSERT INTO CTHD VALUES(1004,'TV02',10)
INSERT INTO CTHD VALUES(1004,'TV03',10)
INSERT INTO CTHD VALUES(1004,'TV04',10)
INSERT INTO CTHD VALUES(1005,'TV05',50)
INSERT INTO CTHD VALUES(1005,'TV06',50)
INSERT INTO CTHD VALUES(1006,'TV07',20)
INSERT INTO CTHD VALUES(1006,'ST01',30)
INSERT INTO CTHD VALUES(1006,'ST02',10)
INSERT INTO CTHD VALUES(1007,'ST03',10)
INSERT INTO CTHD VALUES(1008,'ST04',8)
INSERT INTO CTHD VALUES(1009,'ST05',10)
INSERT INTO CTHD VALUES(1010,'TV07',50)
INSERT INTO CTHD VALUES(1010,'ST07',50)
INSERT INTO CTHD VALUES(1010,'ST08',100)
INSERT INTO CTHD VALUES(1010,'ST04',50)
INSERT INTO CTHD VALUES(1010,'TV03',100)
INSERT INTO CTHD VALUES(1011,'ST06',50)
INSERT INTO CTHD VALUES(1012,'ST07',3)
INSERT INTO CTHD VALUES(1013,'ST08',5)
INSERT INTO CTHD VALUES(1014,'BC02',80)
INSERT INTO CTHD VALUES(1014,'BB02',100)
INSERT INTO CTHD VALUES(1014,'BC04',60)
INSERT INTO CTHD VALUES(1014,'BB01',50)
INSERT INTO CTHD VALUES(1015,'BB02',30)
INSERT INTO CTHD VALUES(1015,'BB03',7)
INSERT INTO CTHD VALUES(1016,'TV01',5)
INSERT INTO CTHD VALUES(1017,'TV02',1)
INSERT INTO CTHD VALUES(1017,'TV03',1)
INSERT INTO CTHD VALUES(1017,'TV04',5)
INSERT INTO CTHD VALUES(1018,'ST04',6)
INSERT INTO CTHD VALUES(1019,'ST05',1)
INSERT INTO CTHD VALUES(1019,'ST06',2)
INSERT INTO CTHD VALUES(1020,'ST07',10)
INSERT INTO CTHD VALUES(1021,'ST08',5)
INSERT INTO CTHD VALUES(1021,'TV01',7)
INSERT INTO CTHD VALUES(1021,'TV02',10)
INSERT INTO CTHD VALUES(1022,'ST07',1)
INSERT INTO CTHD VALUES(1023,'ST04',6)

-----------------BTTH3-------------------

/*Câu 2*/
alter table SANPHAM
add GHICHU varchar(20)

/*câu 3*/
alter table KHACHHANG
add LOAIKH tinyint

/*câu 4*/
alter table SANPHAM
alter column GHICHU varchar(100)

/*câu 5*/
alter table SANPHAM 
drop column GHICHU

/*câu 6*/
alter table KHACHHANG
alter column LOAIKH varchar(20)

/*Câu 7*/
alter table SANPHAM
add constraint CHEK_DONVI check(DVT in('cay', 'hop', 'cai', 'quyen', 'chuc'))

/*câu 8*/
alter table SANPHAM
add constraint CHEK_GIA check(GIA>=500)

------------------BTTH4-----------------

--Câu 1 done

--Câu 2
select * into SANPHAM1 from SANPHAM 
select * into KHACHHANG1 from KHACHHANG

--Câu 3
update SANPHAM1 
set GIA = GIA * 1.05
where NUOCSX = 'Thai Lan'

--Câu 4
update SANPHAM1
set GIA = GIA * 0.95
where NUOCSX = 'Trung Quoc' and GIA <= 10000

--Câu 5
update KHACHHANG1
set LOAIKH = 'Vip'
where ( NGAYDK < '1/1/2007' and DOANHSO >=10000000 ) or ( NGAYDK >= '1/1/2007' and DOANHSO >= 20000000 ) 
---------------------------------------------------------------------------------------------------------------------
--TRUY VẤN 
--Câu 1
SELECT MaSP,TenSP
FROM SANPHAM
WHERE NUOCSX = 'Trung Quoc'

--Câu 2
SELECT MaSP,TenSp
FROM SANPHAM
WHERE DVT = 'cay'
UNION
SELECT MaSP,TenSP
FROM SANPHAM
WHERE DVT = 'quyen'

--Câu 3
SELECT MaSP,TenSP
FROM SANPHAM
WHERE SUBSTRING(MASP,1,1) = 'B' and SUBSTRING(MASP,3,2) = '01'

--Câu 4
SELECT MaSP,TenSP
FROM SANPHAM
WHERE NUOCSX = 'Trung Quoc' and GIA = 40000

--Câu 5
SELECT MaSP,TenSP
FROM SANPHAM
WHERE NUOCSX = 'Trung Quoc'  and GIA between 30000 and 40000
UNION
SELECT MaSP,TenSP
FROM SANPHAM
WHERE NUOCSX = 'Thai Lan' and GIA between 30000 and 40000

--Câu 6
set dateformat dmy
SELECT SoHD,TRIGIA
FROM HOADON
WHERE NGHD = '01/01/2007' or NGHD = '02/01/2007' 

--Câu 7
set dateformat dmy
SELECT SoHD,TriGIA
FROM HOADON
WHERE month(NGHD) = '1' and year(NGHD) = '2007'
ORDER BY NgHD ASC ,TRIGIA DESC

--Câu 8
set dateformat dmy
SELECT KH.MAKH,HOTEN
FROM KHACHHANG KH join HOADON HD on KH.MAKH = HD.MAKH
WHERE NGHD = '1/1/2007'

--Câu 9
set dateformat dmy
SELECT SoHD,TRIGIA
FROM HOADON HD join NHANVIEN NV on HD.MANV = NV.MANV
WHERE NGHD = '28/10/2006' and HoTen = 'Nguyen Van B'

--Câu 10
SELECT SP.MaSP,TenSP
FROM CTHD join HOADON HD on CTHD.SOHD = HD.SOHD join KHACHHANG KH on KH.MAKH = HD.MAKH join SANPHAM SP on SP.MASP = CTHD.MASP
WHERE month(NgHD) = '10' and year(NGHD) = '2006' and HOTEN = 'Nguyen Van A'

--Câu 11
SELECT SOHD
FROM CTHD
WHERE MASP = 'BB01' 
UNION
SELECT SoHD
FROM CTHD
WHERE MASP = 'BB02'

--Câu 12
SELECT SOHD
FROM CTHD
WHERE MASP = 'BB01'  and SL between 10 and 20 
UNION
SELECT SoHD
FROM CTHD
WHERE MASP = 'BB02' and SL between 10 and 20 

--Câu 13
SELECT SOHD
FROM CTHD
WHERE MASP = 'BB01'  and SL between 10 and 20 
INTERSECT
SELECT SoHD
FROM CTHD
WHERE MASP = 'BB02' and SL between 10 and 20 

--Câu 14
set dateformat dmy
SELECT MASP,TENSP
FROM SANPHAM
WHERE NUOCSX = 'Trung Quoc'
UNION
SELECT SP.MASP,TENSP
FROM SANPHAM SP join CTHD on SP.MASP = CTHD.MASP join HOADON HD on HD.SOHD = CTHD.SOHD
WHERE NGHD = '1/1/2007'

--Câu 15
SELECT MASP,TENSP
FROM SANPHAM
EXCEPT
SELECT SP.MASP,TENSP
FROM SANPHAM SP join CTHD on SP.MASP = CTHD.MASP

--Câu 16
SELECT MASP,TENSP
FROM SANPHAM
EXCEPT
SELECT SP.MASP,TENSP
FROM SANPHAM SP join CTHD on SP.MASP = CTHD.MASP join HOADON HD on CTHD.SOHD = HD.SOHD
WHERE year(NGHD) = '2006'

--Câu 17
SELECT MASP,TENSP
FROM SANPHAM
WHERE NUOCSX = 'Trung Quoc'
EXCEPT
SELECT SP.MASP,TENSP
FROM SANPHAM SP join CTHD on SP.MASP = CTHD.MASP join HOADON HD on CTHD.SOHD = HD.SOHD
WHERE year(NGHD) = '2006'

--Câu 18
SELECT SoHD
FROM HOADON HD
WHERE year(NGHD) = '2006' and not exists( SELECT *
                                          FROM SANPHAM SP
										  WHERE NUOCSX = 'Singapore' and not exists( SELECT *
										                                             FROM CTHD
																					 WHERE HD.SOHD = CTHD.SOHD and SP.MASP = CTHD.MASP))

--Câu 19
SELECT count(SoHD) as SoLuong
FROM HOADON
WHERE MAKH is null

--Câu 20
SELECT count(MaSP) as SoLuong
FROM HOADON HD join CTHD on HD.SOHD = CTHD.SOHD
WHERE year(NGHD) = '2006'

--Câu 21
SELECT max(TRIGIA) as LonNhat,min(TRIGIA) as NHONHAT
FROM HOADON

--Câu 22
SELECT avg(TRIGIA) as TrungBinh
FROM HOADON 
WHERE year(NGHD) = '2006'

--Câu 23
SELECT sum(TRIGIA) as DOANHTHU
FROM HOADON
WHERE year(NGHD) = '2006'

--Câu 24
SELECT SOHD
FROM HOADON
WHERE year(NGHD) ='2006' and TRIGIA >= all(SELECT TRIGIA
                                             FROM HOADON
					                         WHERE year(NGHD) = '2006')

--Câu 25
/*Cách ngu ngốc*/
SELECT HOTEN
FROM KHACHHANG KH join HOADON HD on KH.MaKH = HD.MAKH
WHERE SOHD in(SELECT SOHD
              FROM HOADON
              WHERE year(NGHD) ='2006' and TRIGIA >= all(SELECT TRIGIA
                                                         FROM HOADON
					                                     WHERE year(NGHD) = '2006'))
/*Cách thông minh*/
SELECT HOTEN
FROM HOADON HD join KHACHHANG KH on HD.MAKH = KH.MAKH
WHERE year(NGHD) ='2006' and TRIGIA >= all(SELECT TRIGIA
                                             FROM HOADON
					                         WHERE year(NGHD) = '2006')

--Câu 26
SELECT TOP 3 MAKH, HOTEN
FROM KHACHHANG
ORDER BY GIA DESC

--Câu 27
SELECT MASP,TENSP
FROM SANPHAM
WHERE GIA in(SELECT TOP 3 GIA
                FROM SANPHAM 
				ORDER BY MASP)

--Câu 28
SELECT MASP,TENSP
FROM SANPHAM
WHERE NuocSX = 'Thai Lan' and GIA in(SELECT TOP 3 GIA
                                     FROM SANPHAM 
				                     ORDER BY GIA DESC)

--Câu 29
SELECT MASP,TENSP
FROM SANPHAM
WHERE NuocSX = 'Trung Quoc' and GIA in(SELECT TOP 3 GIA
                                     FROM SANPHAM
									 WHERE NUOCSX = 'Trung Quoc'
									 ORDER BY GIA DESC)

--Câu 30
SELECT TOP 3 MAKH, HOTEN
FROM KHACHHANG
ORDER BY DOANHSO DESC

--Câu 31
SELECT count(MaSP) as SoLuong
FROM SANPHAM
WHERE NUOCSX = 'Trung Quoc'

--Câu 32
SELECT NUOCSX,count(MaSP) as SoLuong 
FROM SANPHAM 
GROUP BY NUOCSX

--Câu 33
SELECT NUOCSX,max(GIA) as GBCN,min(GIA) as GBTN,avg(GIA) as GTTB
FROM SANPHAM
GROUP BY NUOCSX

--Câu 34
SELECT NGHD, sum(TRIGIA) as DOANHTHU
FROM HOADON
GROUP BY NGHD

--Câu 35
SELECT MaSP,sum(SL) as TongSoLuong
FROM CTHD join HOADON HD on CTHD.SOHD = HD.SOHD
WHERE month(NGHD) = '10' and year(NGHD) = '2006'
GROUP BY MaSP

--Câu 36
SELECT month(NGHD) as THANG,sum(TRIGIA) as DOANHTHU
FROM HOADON
WHERE year(NGHD) = '2006'
GROUP BY month(NGHD)

--Câu 37
SELECT SoHD
FROM CTHD
GROUP BY SoHD
HAVING Count(MASP)>=4

--Câu 38
SELECT SoHD
FROM CTHD join SANPHAM SP on CTHD.MASP = SP.MASP
WHERE NUOCSX = 'Viet Nam'
GROUP BY SoHD
HAVING Count(CTHD.MASP) = 3

--Câu 39
SELECT KH.MaKH,HOTEN
FROM KHACHHANG KH join HOADON HD on KH.MAKH = HD.MAKH
GROUP BY KH.MaKH,HoTEN
HAVING count(SoHD) >= all( SELECT count(SoHD)
                           FROM HOADON
						   GROUP BY MAKH)

--Câu 40
SELECT month(NGHD) as Thang
FROM HOADON
GROUP BY month(NGHD)
HAVING sum(TRIGIA) >= all( SELECT sum(TRIGIA)
                           FROM HOADON
						   GROUP BY month(NgHD))

--Câu 41
SELECT SP.MASP,TENSP
FROM SANPHAM SP join CTHD on SP.MASP = CTHD.MASP
GROUP BY SP.MASP,TENSP
HAVING sum(SL) <= all (SELECT sum(SL)
                       FROM CTHD
					   GROUP BY MASP)

--Câu 42
SELECT NUOCSX,MaSP,TenSP
FROM SANPHAM SP
WHERE GIA  in( SELECT max(GIA) 
               FROM SANPHAM SP1
			   WHERE SP.NUOCSX = SP1.NUOCSX)
GROUP BY NUOCSX,MASP,TenSP

--Câu 43
SELECT NUOCSX
FROM SANPHAM
GROUP BY NUOCSX
HAVING count( distinct MaSP) >= 3

--Câu 44
SELECT KHTOP10.MAKH,HOTEN
FROM (SELECT TOP 10 MAKH,HOTEN
      FROM KHACHHANG 
	  ORDER BY DOANHSO DESC) KHTOP10 join HOADON HD on KHTOP10.MAKH = HD.MAKH 
GROUP BY KHTOP10.MAKH,HOTEN
HAVING count(SoHD) >= all( SELECT count(SOHD)
                           FROM (SELECT TOP 10 MAKH,HOTEN
                                 FROM KHACHHANG 
	                             ORDER BY DOANHSO DESC) KHTOP10 join HOADON HD on KHTOP10.MAKH = HD.MAKH 
						   GROUP BY KHTOP10.MAKH)

